<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Angular4-HTTP  JSONP - seanchann</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="seanchann" /><meta name="description" content="angular开发中，JSONP的使用说明" />

  <meta name="keywords" content="seanchann, blog" />






<meta name="generator" content="Hugo 0.26-DEV" />


<link rel="canonical" href="https://blog.ucatch.me/post/angular/http-example-jsonp-observables/" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.ucatch.me/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.ucatch.me/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.ucatch.me/favicon-16x16.png">
<link rel="icon" href="https://blog.ucatch.me/favicon.ico" />
<link rel="manifest" href="https://blog.ucatch.me/manifest.json">
<link rel="mask-icon" href="https://blog.ucatch.me/safari-pinned-tab.svg" color="#5bbad5">


<link href="https://blog.ucatch.me/dist/even.min.css?v=2.6.1" rel="stylesheet">
<link href="https://blog.ucatch.me/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">

<meta property="og:title" content="Angular4-HTTP  JSONP" />
<meta property="og:description" content="angular开发中，JSONP的使用说明" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.ucatch.me/post/angular/http-example-jsonp-observables/" />



<meta property="article:published_time" content="2017-10-16T17:43:42&#43;00:00"/>
<meta property="article:modified_time" content="2017-10-16T17:43:42&#43;00:00"/>











<meta itemprop="name" content="Angular4-HTTP  JSONP">
<meta itemprop="description" content="angular开发中，JSONP的使用说明">


<meta itemprop="dateModified" content="2017-10-16T17:43:42&#43;00:00" />
<meta itemprop="wordCount" content="1947">



<meta itemprop="keywords" content="angular,http," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Angular4-HTTP  JSONP"/>
<meta name="twitter:description" content="angular开发中，JSONP的使用说明"/>

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js" integrity="sha256-9uAoNWHdszsUDhSXf/rVcWOqKPfi5/8V5R4UdbZle2A=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js" crossorigin="anonymous"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="https://blog.ucatch.me/" class="logo">seanchann</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="https://blog.ucatch.me/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="https://blog.ucatch.me/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="https://blog.ucatch.me/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="https://blog.ucatch.me/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="https://blog.ucatch.me/about/">
        <li class="mobile-menu-item">About me</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="https://blog.ucatch.me/" class="logo">seanchann</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="https://blog.ucatch.me/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://blog.ucatch.me/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://blog.ucatch.me/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://blog.ucatch.me/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://blog.ucatch.me/about/">About me</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Angular4-HTTP  JSONP</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-10-16 </span>
        <div class="post-category">
            <a href="https://blog.ucatch.me/categories/angular/">angular</a>
          </div>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#学习目标">学习目标</a></li>
<li><a href="#jsonp是什么">JSONP是什么</a></li>
<li><a href="#重构">重构</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#代码清单">代码清单</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="学习目标">学习目标</h2>

<ul>
<li>JSONP是什么以及它如何客服CORS</li>
<li>在Angular中如果发起JSONP的请求</li>
</ul>

<p></p>

<h2 id="jsonp是什么">JSONP是什么</h2>

<p>JSONP是一种绕过CORS问题来发起API请求的一种方法。</p>

<p>这是一种在所有的浏览器上的安全的实现,它避免了很多未知的访问请求.</p>

<p>由于CORS的问题,当我们通过http客户端库来发起到iTunes API的时候,浏览器将会抛出CORS错误.</p>

<p>这个解释是深刻和复杂的，但总而言之，除非API在响应中设置某些Header，否则浏览器将拒绝该响应，所以我们使用的iTune API不会在默认情况下将添加这些Header给任何响应,所以会被拒绝。</p>

<p>到目前为止,我们修正这个问题的方法是安装一些插件,它们会拦截应答,然后添加一些必要的Headers再返回给浏览器.但是如果你想要发布程序,那么这就不是一个解决方法的手段,用户不会帮你装插件.</p>

<p>如果我们关闭插件,尝试执行程序,我们仍然会得到下面的错误:</p>

<pre><code class="language-text">XMLHttpRequest cannot load https://itunes.apple.com/search?term=love&amp;media=music&amp;limit=20. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://run.plnkr.co' is therefore not allowed access.
</code></pre>

<p><code>JSONP</code>是一个解决问题的方法,它将API视为一个<code>javascript</code>文件,当在HTML有这个<code>script</code>标签的时候动态的加载<code>https://itunes.apple.com/search?term=love&amp;media=music&amp;limit=20</code></p>

<pre><code class="language-HTML">&lt;script src=&quot;https://itunes.apple.com/search?term=love&amp;media=music&amp;limit=20&quot;&gt;&lt;/script&gt;
</code></pre>

<p>浏览器会下载javascript文件,由于在下载的时候,浏览器不会检查CORS,因此就避开了CORS的问题.</p>

<p>想象下从服务返回的应答是<code>{hello:'world'}</code>,我们不仅仅是想下载文件因为:</p>

<ol>
<li>浏览器将会下载json然后尝试去执行它,由于json不是脚本,这里什么也不会发生.</li>
<li>我们想要当json下载完成后做一些针对json的操作.比如调用函数来解析数据.</li>
</ol>

<p>因此APIs支持JSONP返回一些类似javascript的内容,比如</p>

<pre><code class="language-text">process_response({hello:'world'});
</code></pre>

<p>当文件下载完成,它就会立即执行上面的操作来处理从API返回的数据.</p>

<p>当然,我们需要一个<code>process_response</code>的函数已经就绪在我们的程序中.如果使用框架,它已经支持了JSONP,这些细节框架都会帮我们处理好.</p>

<p>简而言之,这就是JSONP:</p>

<ol>
<li>将API视为javascript file</li>
<li>API将JSON的响应包装到我们定义好的函数中.</li>
<li>当浏览器下载这个奇怪的API脚本,它就会执行这个函数.</li>
</ol>

<p>我们可以在下面的情形中使用JSONP</p>

<ol>
<li>API自身就支持JSONP.它必须返回一个函数包装了json数据的内容.通常还必须允许我们通过请求参数来传入我们的处理函数的名字</li>
<li>我们只能发起GET请求,它不支持<code>PUT/POST/DELETE</code>方法.</li>
</ol>

<h2 id="重构">重构</h2>

<p>现在我们了解了<code>JSONP</code>并且iTunes API自身就支持JSONP,让我们来对程序进行重构</p>

<p>在<code>JsonpModule</code>中有<code>Jsonp</code>来实现我们要的功能.因此首先,我们导入这个模块,替换所有的<code>Http</code>为<code>Jsonp</code></p>

<pre><code class="language-typescript">import {JsonpModule, Jsonp, Response} from '@angular/http';
.
.
.
@NgModule({
  imports: [
    BrowserModule,
    ReactiveFormsModule,
    FormsModule,
    JsonpModule 
  ],
  declarations: [AppComponent],
  bootstrap: [AppComponent],
  providers: [SearchService]
})
class AppModule { }
</code></pre>

<p>上面添加了<code>JsonpModule</code>到模块的导入部分</p>

<p>然后让我们修改下<code>SearchService</code>来使用<code>Jsonp</code>,例如:</p>

<pre><code class="language-typescript">@Injectable()
export class SearchService {
  apiRoot: string = 'https://itunes.apple.com/search';

  constructor(private jsonp: Jsonp) { 
  }

  search(term: string) {
    let apiURL = `${this.apiRoot}?term=${term}&amp;media=music&amp;limit=20&amp;callback=JSONP_CALLBACK`; 
    return this.jsonp.request(apiURL)  
        .map(res =&gt; {
          return res.json().results.map(item =&gt; {
            return new SearchItem(
                item.trackName,
                item.artistName,
                item.trackViewUrl,
                item.artworkUrl30,
                item.artistId
            );
          });
        });
  }
}
</code></pre>

<ul>
<li>我们注入了<code>Jsonp</code>到构造函数中,并且保存为<code>jsonp</code></li>
<li>修改了apiURL田间了参数<code>callback=JSONP_CALLBACK</code></li>
<li>替换<code>http.get()</code>为<code>jsonp.request()</code></li>
</ul>

<blockquote>
<p>iTunes API支持JSONP,我们需要通过请求参数来告诉接口回调函数的名字
我们传入了<code>JSONP_CALLBACK</code>
angular将会每次替换<code>JSONP_CALLBACK</code>为一个自动生成的函数名来发起请求</p>
</blockquote>

<p>就是这样，其余的代码是完全一样的，应用程序的工作原理就像以前一样。</p>

<blockquote>
<p>注意,如果你装了CORS的插件,这个时候需要关掉它.</p>
</blockquote>

<h2 id="总结">总结</h2>

<p>JSONP是一个解决CORS问题的普遍采用的方法.</p>

<p>我们只能使用JSONP当API支持JSONP的时候.</p>

<p>在Angular中使用JSONP,我们直接使用封装好的<code>Jsonp</code>客户端库.导入<code>JsonpModule</code>并且添加到我们的<code>NgModule</code></p>

<p>调用<code>request</code>函数来完成请求,它仍然是返回了<code>Observable</code>,因此我们的程序直接替换<code>Http</code>为<code>Jsonp</code>是可行的.</p>

<h2 id="代码清单">代码清单</h2>

<pre><code class="language-typescript">import {NgModule, Component, Injectable} from '@angular/core';
import {BrowserModule} from '@angular/platform-browser';
import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';
import {JsonpModule, Jsonp, Response} from '@angular/http';
import {ReactiveFormsModule, FormControl, FormsModule} from '@angular/forms';
import {Observable} from 'rxjs';
import 'rxjs/add/operator/map';
import 'rxjs/add/operator/debounceTime';
import 'rxjs/add/operator/distinctUntilChanged';
import 'rxjs/add/operator/switchMap';
import 'rxjs/add/operator/do';

class SearchItem {
  constructor(public track: string,
              public artist: string,
              public link: string,
              public thumbnail: string,
              public artistId: string) {
  }
}

@Injectable()
export class SearchService {
  apiRoot: string = 'https://itunes.apple.com/search';

  constructor(private jsonp: Jsonp) {
  }

  search(term: string) {
    let apiURL = `${this.apiRoot}?term=${term}&amp;media=music&amp;limit=20&amp;callback=JSONP_CALLBACK`;
    return this.jsonp.request(apiURL)
        .map(res =&gt; {
          return res.json().results.map(item =&gt; {
            return new SearchItem(
                item.trackName,
                item.artistName,
                item.trackViewUrl,
                item.artworkUrl30,
                item.artistId
            );
          });
        });
  }
}

@Component({
  selector: 'app',
  template: `
&lt;form class=&quot;form-inline&quot;&gt;
  &lt;div class=&quot;form-group&quot;&gt;
    &lt;input type=&quot;search&quot;
           class=&quot;form-control&quot;
           placeholder=&quot;Enter search string&quot;
           [formControl]=&quot;searchField&quot;&gt;
  &lt;/div&gt;
&lt;/form&gt;

&lt;div class=&quot;text-center&quot;&gt;
  &lt;p class=&quot;lead&quot; *ngIf=&quot;loading&quot;&gt;Loading...&lt;/p&gt;
&lt;/div&gt;

&lt;ul class=&quot;list-group&quot;&gt;
  &lt;li class=&quot;list-group-item&quot;
      *ngFor=&quot;let track of results | async&quot;&gt;
    &lt;img src=&quot;{{track.thumbnail}}&quot;&gt;
    &lt;a target=&quot;_blank&quot;
       href=&quot;{{track.link}}&quot;&gt;{{ track.track }}
    &lt;/a&gt;
  &lt;/li&gt;
&lt;/ul&gt;
 `
})
class AppComponent {
  private loading: boolean = false;
  private results: Observable&lt;SearchItem[]&gt;;
  private searchField: FormControl;

  constructor(private itunes: SearchService) {
  }

  ngOnInit() {
    this.searchField = new FormControl();
    this.results = this.searchField.valueChanges
        .debounceTime(400)
        .distinctUntilChanged()
        .do(_ =&gt; this.loading = true)
        .switchMap(term =&gt; this.itunes.search(term))
        .do(_ =&gt; this.loading = false)
  }
}

@NgModule({
  imports: [
    BrowserModule,
    ReactiveFormsModule,
    FormsModule,
    JsonpModule
  ],
  declarations: [AppComponent],
  bootstrap: [AppComponent],
  providers: [SearchService]
})
class AppModule {
}

platformBrowserDynamic().bootstrapModule(AppModule);
</code></pre>

<div>
<a href='../../angular/http-example-observables'>上一章 Angular HTTP Observable</a>
</div>
    </div>

    
    

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="https://blog.ucatch.me/img/reward/wechat.png">
        <span>微信打赏</span>
      </label>
    
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="https://blog.ucatch.me/tags/angular/">angular</a>
          
          <a href="https://blog.ucatch.me/tags/http/">http</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="https://blog.ucatch.me/post/angular/http-example-observables/">
            <span class="next-text nav-default">Angular4-HTTP  基于observable的例子</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
        
        
        if (window.location.hostname === 'localhost') return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'seanchann';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com/" class="dsq-brlink" target="_blank">comments powered by <span class="logo-disqus">Disqus</span></a>

  
      </div>  
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:seanchann@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/seanchann" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.ucatch.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    &copy; 
    2017
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">seanchann</span>
    <p class="credits theme-by text-muted">Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>    
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="https://blog.ucatch.me/lib/highlight/highlight.pack.js"></script>
<script type="text/javascript" src="https://blog.ucatch.me/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://blog.ucatch.me/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="https://blog.ucatch.me/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="https://blog.ucatch.me/dist/even.min.js?v=2.6.1"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-62644170-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



</body>
</html>
